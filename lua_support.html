<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Lua Support</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.8.11 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Lua Support </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="lua_support_overview"></a>
Overview</h1>
<p>JamPlus has built in Lua support, provided through a minimal distribution of LuaPlus (<a href="http://luaplus.org/">http://luaplus.org/</a>). Lua scripts may be run during the <a class="el" href="jam_language.html#operation_parsing">Parsing Phase</a> and during the <a class="el" href="jam_language.html#operation_updating">Updating Phase</a>.</p>
<p>The scripts located in <code>bin/scripts/</code> are written in Lua, although they are executed external to the Jam executable.</p>
<hr/>
 <h1><a class="anchor" id="lua_support_rules"></a>
Using Lua during the Parsing Phase</h1>
<p>There are two rules for execution of Lua script available for use during the rule parsing phase of JamPlus. They are <a class="el" href="lua_support.html#rule_LuaString">rule LuaString LUA_SCRIPT</a> and <a class="el" href="lua_support.html#rule_LuaFile">rule LuaFile LUA_FILENAME</a>.</p>
<h2><a class="anchor" id="rule_LuaString"></a>
rule LuaString LUA_SCRIPT</h2>
<p><a name="arule_:4cua:53tring"></a></p>
<p> <blockquote> </p>
<p>Executes <code>LUA_SCRIPT</code>, returning any results back to the caller.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">LUA_SCRIPT</td><td>Syntactically correct Lua script embedded in a string. Only the first string list item is executed. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>If the Lua script doesn't return any values, the return value is an empty list. If the Lua script does return values, the return values are transformed to a Jam string list. Nested tables are collapsed.</dd></dl>
<p> </blockquote> </p>
<h2><a class="anchor" id="rule_LuaFile"></a>
rule LuaFile LUA_FILENAME</h2>
<p><a name="arule_:4cua:46ile"></a></p>
<p> <blockquote> </p>
<p>Executes <code>LUA_FILENAME</code>, returning any results back to the caller.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">LUA_FILENAME</td><td>The filename of the Lua script to run. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>If the Lua script doesn't return any values, the return value is an empty list. If the Lua script does return values, the return values are transformed to a Jam string list. Nested tables are collapsed.</dd></dl>
<p> </blockquote> </p>
<hr/>
 <h1><a class="anchor" id="lua_support_actions"></a>
Using Lua in Actions</h1>
<p>Using the new <code>lua</code> modifier for an action, Lua script can be run in a thread within the Jam process.</p>
<p> <blockquote>  </p><div class="fragment"><div class="line">actions lua RunLuaScript</div><div class="line">{</div><div class="line">    osprocess = require <span class="stringliteral">&#39;osprocess&#39;</span></div><div class="line">    osprocess.sleep($(SLEEP))</div><div class="line">    print($(TEXT))</div><div class="line">}</div></div><!-- fragment --><p>  </blockquote> </p>
<hr/>
 <h1><a class="anchor" id="lua_support_line_filters"></a>
Lua Line Filters</h1>
<p>The <code>LineFilters</code> table contains a mapping of an action name to a line-by-line parsing function. For every line of output received by the action, the appropriate <code>LineFilters</code> table actionname-&gt;function is run. The function can do with the output what it wants and return the result.</p>
<p>For example, in the <code>LineFilters.Compiler</code> function and action below, a GCC-style error message is changed into a Visual C++ compatible error message.</p>
<p> <blockquote>  </p><div class="fragment"><div class="line">USE_LUA_LINE_FILTERS = 1 ;</div><div class="line"></div><div class="line">LuaString <span class="stringliteral">&quot;</span></div><div class="line"><span class="stringliteral">    LineFilters.UpperCaseRule = function(input)</span></div><div class="line"><span class="stringliteral">        return &#39;-&gt; &#39; .. input:upper()</span></div><div class="line"><span class="stringliteral">    end</span></div><div class="line"><span class="stringliteral">    LineFilters.LowerCaseRule = function(input)</span></div><div class="line"><span class="stringliteral">        return &#39;-&gt; &#39; .. input:lower()</span></div><div class="line"><span class="stringliteral">    end</span></div><div class="line"><span class="stringliteral">    LineFilters.Compiler = function(input)</span></div><div class="line"><span class="stringliteral">        return input:gsub(&#39;(.-):(%d+):(.+)&#39;, &#39;%1(%2) %3&#39;)</span></div><div class="line"><span class="stringliteral">    end</span></div><div class="line"><span class="stringliteral">&quot;</span> ;</div><div class="line"></div><div class="line">actions UpperCaseRule {</div><div class="line">    echo This text will be uppercase.</div><div class="line">    echo This text will also be uppercase in the output.</div><div class="line">}</div><div class="line"></div><div class="line">actions LowerCaseRule {</div><div class="line">    echo THIS TEXT will be LOWERCASE.</div><div class="line">}</div><div class="line"></div><div class="line">actions Compiler {</div><div class="line">    echo c:\the\directory\filename.cpp:1000:This is an error message.</div><div class="line">}</div><div class="line"></div><div class="line">Always all ;</div><div class="line">UpperCaseRule all ;</div><div class="line">LowerCaseRule all ;</div><div class="line">Compiler all ;</div></div><!-- fragment --><p>  </blockquote> </p>
<hr/>
 <h1><a class="anchor" id="lua_support_module_jam"></a>
Accessing Jam from Lua</h1>
<p>Within a Lua script, it is possible to access Jam variables and execute Jam rules. A special Jam module and accompanying Lua script, both found in <code>bin/modules/luasupport.*</code> provide some extra ease of use over the direct calling conventions seen in the next section.</p>
<p>To make this support available within your Jam scripts, execute the following:</p>
<div class="fragment"><div class="line">LuaSupport ;</div></div><!-- fragment --><p>From this point on, several new Jam-related namespaces become available in Lua accessed by <code>jam</code>, <code>jamtarget</code>, and <code>jamvar</code>. By indexing members of those namespaces from Lua, that functionality of Jam feels more seamlessly integrated. However, in the section below, a more rich API lets you access most Jam functionality.</p>
<p>To read or write from any variables currently within scope in Jam, use the Lua-provided <code>jamvar</code> table.</p>
<div class="fragment"><div class="line"><span class="preprocessor"># Jam:</span></div><div class="line">GameAssets = assets ;</div><div class="line">GameSoundAssets = $(GameAssets)/sound ;</div><div class="line"></div><div class="line">MyVariable = Hello ;</div><div class="line">MyListOfStrings = Hello how are you? ;</div><div class="line"></div><div class="line">-- Lua equivalent:</div><div class="line">jamvar.GameAssets = <span class="stringliteral">&quot;assets&quot;</span></div><div class="line">jamvar.GameSoundAssets = jamvar.GameAssets[1] .. <span class="stringliteral">&#39;/sound&#39;</span></div><div class="line"></div><div class="line">jamvar.MyVariable = <span class="stringliteral">&quot;Hello&quot;</span></div><div class="line">jamvar.MyListOfStrings = { <span class="stringliteral">&#39;Hello&#39;</span>, <span class="stringliteral">&#39;how&#39;</span>, <span class="stringliteral">&#39;are&#39;</span>, <span class="stringliteral">&#39;you?&#39;</span> }</div></div><!-- fragment --><p>The only data type in Jam is a list of strings, so even <code>GameAssets</code> containing a single path is still a list of strings containing only one element. Within Lua, <code>jamvar.GameAssets</code> is a table containing an array of strings with the only element being <code>$(SUBDIR)/assets</code>. Therefore, to access the actual contents of a Jam-provided string list requires indexing into the returned table.</p>
<p>It is also possible to access a Jam target directly.</p>
<div class="fragment"><div class="line"><span class="preprocessor"># Jam:</span></div><div class="line">SEARCH on &lt;GameAssets|source&gt;StringTable.lua = $(COOKED_PATH) ;</div><div class="line"></div><div class="line">local search ;</div><div class="line">on &lt;GameAssets|source&gt;StringTable.lua search = $(SEARCH) ;</div><div class="line"></div><div class="line"><span class="preprocessor">#    or:</span></div><div class="line">local search = $(SEARCH:Z=&lt;GameAssets|source&gt;StringTable.lua) ;</div><div class="line"></div><div class="line">-- Lua:</div><div class="line">jamtarget[<span class="stringliteral">&#39;&lt;GameAssets|source&gt;StringTable.lua&#39;</span>].SEARCH = COOKED_PATH</div><div class="line">local search = jamtarget[<span class="stringliteral">&#39;&lt;GameAssets|source&gt;StringTable.lua&#39;</span>].SEARCH</div></div><!-- fragment --><p>Evaluating a rule is done with ease within the <code>jam</code> namespace:</p>
<div class="fragment"><div class="line"><span class="preprocessor"># Jam:</span></div><div class="line">local inputTarget = &lt;GameAssets|source&gt;StringTable.lua ;</div><div class="line">local inputTarget2 = &lt;GameAssets|source&gt;StringTable.merge.lua ;</div><div class="line">local outputTarget = &lt;GameAssets&gt;StringTable.lua ;</div><div class="line">Depends assets : $(outputTarget) : $(inputTarget) $(inputTarget2) ;</div><div class="line"></div><div class="line">-- Lua:</div><div class="line">local inputTarget = <span class="stringliteral">&#39;&lt;GameAssets|source&gt;StringTable.lua&#39;</span></div><div class="line">local inputTarget2 = <span class="stringliteral">&#39;&lt;GameAssets|source&gt;StringTable.merge.lua&#39;</span></div><div class="line">local outputTarget = <span class="stringliteral">&#39;&lt;GameAssets&gt;StringTable.lua&#39;</span></div><div class="line">jam.Depends(<span class="stringliteral">&#39;assets&#39;</span>, outputTarget, { inputTarget, inputTarget2 })</div></div><!-- fragment --><p>Note that single element data types in Lua are automatically converted to a list of strings for Jam. That means that the second parameter to <code>jam.Depends</code> is converted to <code>{ outputTarget }</code>.</p>
<p>The <code>jam</code> namespace provides the most useful access to Jam functionality. It does not cover the full range of Jam features. For a more extensive API to access Jam from Lua, see the next section.</p>
<hr/>
 <h1><a class="anchor" id="lua_support_jam"></a>
Lua to Jam API</h1>
<p>Within a Lua script, it is possible to access Jam variables and execute Jam rules.</p>
<h2><a class="anchor" id="lua_jam_action"></a>
function jam_action(ACTION_NAME, ACTION_TEXT [, FLAGS])</h2>
<p><a name="alua_jam_action"></a></p>
<p> <blockquote> </p>
<p>Creates an action to be executed by Jam called <code>ACTION_NAME</code> made up of <code>ACTION_TEXT</code>. If written in the Jam language, the equivalent would be:</p>
<p> <blockquote>  </p><div class="fragment"><div class="line">jam_action(ACTION_NAME, ACTION_TEXT)</div><div class="line"></div><div class="line">is equivalent to:</div><div class="line"></div><div class="line">actions ACTION_NAME</div><div class="line">{</div><div class="line">    ACTION_TEXT</div><div class="line">}</div></div><!-- fragment --><p>  </blockquote> </p>
<p>If <code>FLAGS</code> is specified as a table, those flags are applied to the action and have direct correspondence to action modifiers specified in a Jam action.</p>
<p> <blockquote>  </p><div class="fragment"><div class="line">jam_action(ACTION_NAME, ACTION_TEXT, { updated = <span class="keyword">true</span>, together = <span class="keyword">true</span> })</div><div class="line"></div><div class="line">is equivalent to:</div><div class="line"></div><div class="line">actions updated together ACTION_NAME</div><div class="line">{</div><div class="line">    ACTION_TEXT</div><div class="line">}</div></div><!-- fragment --><p>  </blockquote> </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ACTION_NAME</td><td>The name of any valid Jam action. </td></tr>
    <tr><td class="paramname">ACTION_TEXT</td><td>Text representing the commands to be executed by the shell. </td></tr>
    <tr><td class="paramname">FLAGS</td><td>(optional) If specifed, <code>FLAGS</code> must be a table of action modifiers containing one or more of the following: <code>bind = { 'various', 'target', 'names' }</code>, <code>existing = true</code>,<code>ignore = true</code>, <code>lua = true</code>,<code>maxline = true</code>, <code>maxresponse = true</code>, <code>piecemeal = true</code>, <code>quietly = true</code>, <code>removeemptydirs = true</code>, <code>response = true</code>, <code>screenoutput = true</code>, <code>together = true</code>, <code>updated = true</code></td></tr>
  </table>
  </dd>
</dl>
<p> </blockquote> </p>
<h2><a class="anchor" id="lua_jam_evaluaterule"></a>
function jam_evaluaterule(RULE_NAME [, PARAMETERS])</h2>
<p><a name="alua_jam_evaluaterule"></a></p>
<p> <blockquote> </p>
<p>Executes rule <code>RULE_NAME</code> using any optional <code>PARAMETERS</code> specified. Returns the result as a Lua table.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">RULE_NAME</td><td>The name of any valid Jam rule. </td></tr>
    <tr><td class="paramname">PARAMETERS</td><td>(optional) If specifed, the <code>PARAMETERS</code> are collapsed into a Jam string list and passed to the rule. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>If the Jam rule doesn't return any values, the return value is <code>nil</code>. If the Jam rule does return values, the return values are transformed to a Lua array of strings.</dd></dl>
<p> </blockquote> </p>
<h2><a class="anchor" id="lua_jam_expand"></a>
function jam_expand(TEXT_TO_EXPAND)</h2>
<p><a name="alua_jam_expand"></a></p>
<p> <blockquote> </p>
<p>Expands <code>TEXT_TO_EXPAND</code> according to Jam rules. <code>TEXT_TO_EXPAND</code> must use the $() or @() expansion forms described elsewhere.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TEXT_TO_EXPAND</td><td>The text to expand. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Returns the expanded text.</dd></dl>
<p> </blockquote> </p>
<h2><a class="anchor" id="lua_jam_getvar"></a>
function jam_getvar([ TARGET_NAME, ] VARIABLE_NAME)</h2>
<p><a name="alua_jam_getvar"></a></p>
<p> <blockquote> </p>
<p>Retrieves <code>VARIABLE_NAME</code> from the active Jam globals and returns it as a table of strings.</p>
<p>If <code>TARGET_NAME</code> is specified, <code>VARIABLE_NAME</code> is retrieved as if an <code>on TARGET_NAME</code> had been issued in Jam.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TARGET_NAME</td><td>(optional) The target to make active to retrieve <code>VARIABLE_NAME</code> from. </td></tr>
    <tr><td class="paramname">VARIABLE_NAME</td><td>The Jam variable to retrieve. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>All strings within the <code>VARIABLE_NAME</code> string are returned as a Lua array of strings.</dd></dl>
<p> </blockquote> </p>
<h2><a class="anchor" id="lua_jam_parse"></a>
function jam_parse(TEXT_TO_PARSE)</h2>
<p><a name="alua_jam_parse"></a></p>
<p> <blockquote> </p>
<p>Parses <code>TEXT_TO_PARSE</code> as if it existed in a Jamfile.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TEXT_TO_PARSE</td><td>Jam source code to be parsed and executed by Jam immediately.</td></tr>
  </table>
  </dd>
</dl>
<p> </blockquote> </p>
<h2><a class="anchor" id="lua_jam_print"></a>
function jam_print(TEXT_TO_PRINT)</h2>
<p><a name="alua_jam_print"></a></p>
<p> <blockquote> </p>
<p>Prints <code>TEXT_TO_PRINT</code> to the standard output stream.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TEXT_TO_PRINT</td><td>The text to print.</td></tr>
  </table>
  </dd>
</dl>
<p> </blockquote> </p>
<h2><a class="anchor" id="lua_jam_setvar"></a>
function jam_setvar([ TARGET_NAME, ] VARIABLE_NAME, VALUE)</h2>
<p><a name="alua_jam_setvar"></a></p>
<p> <blockquote> </p>
<p>Sets <code>VALUE</code> into the active Jam global <code>VARIABLE_NAME</code>. <code>VALUE</code> can be a boolean, number, string, or table. Nested tables are collapsed.</p>
<p>If <code>TARGET_NAME</code> is specified, <code>VALUE</code> is set into <code>VARIABLE_NAME</code> as if an <code>VARIABLE_NAME on TARGET_NAME</code> had been issued in Jam.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TARGET_NAME</td><td>(optional) The target to make active to set <code>VARIABLE_NAME</code> into. </td></tr>
    <tr><td class="paramname">VARIABLE_NAME</td><td>The Jam variable to set.</td></tr>
  </table>
  </dd>
</dl>
<p> </blockquote> </p>
<hr/>
 <h1><a class="anchor" id="lua_support_examples"></a>
Examples</h1>
<p> <blockquote>  </p><div class="fragment"><div class="line"><span class="preprocessor"># Hello</span></div><div class="line">LuaString <span class="stringliteral">&quot;print(&#39;Hello&#39;)&quot;</span> ;</div><div class="line"></div><div class="line"><span class="preprocessor"># 10 hi false</span></div><div class="line">Echo [ LuaString <span class="stringliteral">&quot;return { 10, &#39;hi&#39;, false }&quot;</span> ] ;</div><div class="line"></div><div class="line"><span class="preprocessor"># 5.suf hello.suf true.suf</span></div><div class="line">var = [ LuaString <span class="stringliteral">&quot;return { 5, &#39;hello&#39;, true }&quot;</span> ] ;</div><div class="line">Echo $(var:S=.suf) ;</div><div class="line"></div><div class="line"><span class="preprocessor">#------------------------------------------------------------------------------</span></div><div class="line"><span class="preprocessor"># Hello world!</span></div><div class="line">var = Hello world! ;</div><div class="line">Echo [ LuaString <span class="stringliteral">&quot;return jam_getvar(&#39;var&#39;)&quot;</span> ] ;</div><div class="line"></div><div class="line"><span class="preprocessor"># Hi everyone</span></div><div class="line">LuaString <span class="stringliteral">&quot;jam_setvar(&#39;var&#39;, &#39;Hi everyone&#39;)&quot;</span> ;</div><div class="line">Echo $(var) ;</div><div class="line"></div><div class="line"><span class="preprocessor"># Hi everyone</span></div><div class="line">Echo [ LuaString <span class="stringliteral">&quot;return jam_getvar(&#39;var&#39;)&quot;</span> ] ;</div><div class="line"></div><div class="line"><span class="preprocessor">#------------------------------------------------------------------------------</span></div><div class="line"><span class="preprocessor"># The Variable Contents</span></div><div class="line">MyVariable on mytarget = The Variable Contents ;</div><div class="line">Echo [ LuaString <span class="stringliteral">&quot;return jam_getvar(&#39;mytarget&#39;, &#39;MyVariable&#39;)&quot;</span> ] ;</div><div class="line"></div><div class="line"><span class="preprocessor"># **hello**</span></div><div class="line">LuaString <span class="stringliteral">&quot;jam_setvar(&#39;mytarget&#39;, &#39;MyVariable&#39;, &#39;**hello**&#39;)&quot;</span> ;</div><div class="line">Echo [ LuaString <span class="stringliteral">&quot;return jam_getvar(&#39;mytarget&#39;, &#39;MyVariable&#39;)&quot;</span> ] ;</div><div class="line"></div><div class="line">rule ReturnList INPUT</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> **$(INPUT)** ;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="preprocessor"># **MyStuff** **YourStuff**</span></div><div class="line"><span class="preprocessor">Echo [ LuaString &quot;return jam_evaluaterule(&#39;ReturnList&#39;, { &#39;MyStuff&#39;, &#39;YourStuff&#39; })&quot; ] ;</span></div></div><!-- fragment --><p>  </blockquote>  </p>
</div></div><!-- contents -->
</body>
</html>
