<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Lua Support</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.8.9.1 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Lua Support </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="lua_support_overview"></a>
Overview</h1>
<p>JamPlus has built in Lua support, provided through a minimal distribution of LuaPlus (<a href="http://luaplus.org/">http://luaplus.org/</a>). Lua scripts may be run during the <a class="el" href="jam_language.html#operation_parsing">Parsing Phase</a> and during the <a class="el" href="jam_language.html#operation_updating">Updating Phase</a>.</p>
<p>Any LuaBinaries capable module can run in the LuaPlus environment. Just drop the binary in the <code>bin/PLATFORM/LuaPlus/modules/</code> directory or alter the <code>package.path</code> or <code>package.cpath</code></p>
<p>The scripts located in <code>bin/scripts/</code> are written in Lua, although they are executed external to the Jam executable.</p>
<hr/>
 <h1><a class="anchor" id="lua_support_rules"></a>
Using Lua during the Parsing Phase</h1>
<p>There are two rules for execution of Lua script available for use during the rule parsing phase of JamPlus. They are <a class="el" href="lua_support.html#rule_LuaString">rule LuaString LUA_SCRIPT</a> and <a class="el" href="lua_support.html#rule_LuaFile">rule LuaFile LUA_FILENAME</a>.</p>
<h2><a class="anchor" id="rule_LuaString"></a>
rule LuaString LUA_SCRIPT</h2>
<p><a name="rule_%4cua%53tring"></a></p>
<p> <blockquote> </p>
<p>Executes <code>LUA_SCRIPT</code>, returning any results back to the caller.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">LUA_SCRIPT</td><td>Syntactically correct Lua script embedded in a string. Only the first string list item is executed. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>If the Lua script doesn't return any values, the return value is an empty list. If the Lua script does return values, the return values are transformed to a Jam string list. Nested tables are collapsed.</dd></dl>
<p> </blockquote> </p>
<h2><a class="anchor" id="rule_LuaFile"></a>
rule LuaFile LUA_FILENAME</h2>
<p><a name="rule_%4cua%46ile"></a></p>
<p> <blockquote> </p>
<p>Executes <code>LUA_FILENAME</code>, returning any results back to the caller.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">LUA_FILENAME</td><td>The filename of the Lua script to run. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>If the Lua script doesn't return any values, the return value is an empty list. If the Lua script does return values, the return values are transformed to a Jam string list. Nested tables are collapsed.</dd></dl>
<p> </blockquote> </p>
<hr/>
 <h1><a class="anchor" id="lua_support_actions"></a>
Using Lua in Actions</h1>
<p>Using the new <code>lua</code> modifier for an action, Lua script can be run in a thread within the Jam process.</p>
<p> <blockquote>  </p><div class="fragment"><div class="line">actions lua RunLuaScript</div>
<div class="line">{</div>
<div class="line">    osprocess = require <span class="stringliteral">&#39;osprocess&#39;</span></div>
<div class="line">    osprocess.sleep($(SLEEP))</div>
<div class="line">    print($(TEXT))</div>
<div class="line">}</div>
</div><!-- fragment --><p>  </blockquote> </p>
<hr/>
 <h1><a class="anchor" id="lua_support_jam"></a>
Accessing Jam from Lua</h1>
<p>Within a Lua script, it is possible to access Jam variables and execute Jam rules.</p>
<h2><a class="anchor" id="lua_jam_action"></a>
function jam_action(ACTION_NAME, ACTION_TEXT [, FLAGS])</h2>
<p><a name="lua_jam_action"></a></p>
<p> <blockquote> </p>
<p>Creates an action to be executed by Jam called <code>ACTION_NAME</code> made up of <code>ACTION_TEXT</code>. If written in the Jam language, the equivalent would be:</p>
<p> <blockquote>  </p><div class="fragment"><div class="line">jam_action(ACTION_NAME, ACTION_TEXT)</div>
<div class="line"></div>
<div class="line">is equivalent to:</div>
<div class="line"></div>
<div class="line">actions ACTION_NAME</div>
<div class="line">{</div>
<div class="line">    ACTION_TEXT</div>
<div class="line">}</div>
</div><!-- fragment --><p>  </blockquote> </p>
<p>If <code>FLAGS</code> is specified as a table, those flags are applied to the action and have direct correspondence to action modifiers specified in a Jam action.</p>
<p> <blockquote>  </p><div class="fragment"><div class="line">jam_action(ACTION_NAME, ACTION_TEXT, { updated = <span class="keyword">true</span>, together = <span class="keyword">true</span> })</div>
<div class="line"></div>
<div class="line">is equivalent to:</div>
<div class="line"></div>
<div class="line">actions updated together ACTION_NAME</div>
<div class="line">{</div>
<div class="line">    ACTION_TEXT</div>
<div class="line">}</div>
</div><!-- fragment --><p>  </blockquote> </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ACTION_NAME</td><td>The name of any valid Jam action. </td></tr>
    <tr><td class="paramname">ACTION_TEXT</td><td>Text representing the commands to be executed by the shell. </td></tr>
    <tr><td class="paramname">FLAGS</td><td>(optional) If specifed, <code>FLAGS</code> must be a table of action modifiers containing one or more of the following: <code>bind = { 'various', 'target', 'names' }</code>, <code>existing = true</code>,<code>ignore = true</code>, <code>lua = true</code>,<code>maxline = true</code>, <code>maxresponse = true</code>, <code>piecemeal = true</code>, <code>quietly = true</code>, <code>removeemptydirs = true</code>, <code>response = true</code>, <code>screenoutput = true</code>, <code>together = true</code>, <code>updated = true</code></td></tr>
  </table>
  </dd>
</dl>
<p> </blockquote> </p>
<h2><a class="anchor" id="lua_jam_evaluaterule"></a>
function jam_evaluaterule(RULE_NAME [, PARAMETERS])</h2>
<p><a name="lua_jam_evaluaterule"></a></p>
<p> <blockquote> </p>
<p>Executes rule <code>RULE_NAME</code> using any optional <code>PARAMETERS</code> specified. Returns the result as a Lua table.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">RULE_NAME</td><td>The name of any valid Jam rule. </td></tr>
    <tr><td class="paramname">PARAMETERS</td><td>(optional) If specifed, the <code>PARAMETERS</code> are collapsed into a Jam string list and passed to the rule. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>If the Jam rule doesn't return any values, the return value is <code>nil</code>. If the Jam rule does return values, the return values are transformed to a Lua array of strings.</dd></dl>
<p> </blockquote> </p>
<h2><a class="anchor" id="lua_jam_expand"></a>
function jam_expand(TEXT_TO_EXPAND)</h2>
<p><a name="lua_jam_expand"></a></p>
<p> <blockquote> </p>
<p>Expands <code>TEXT_TO_EXPAND</code> according to Jam rules. <code>TEXT_TO_EXPAND</code> must use the $() or @() expansion forms described elsewhere.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TEXT_TO_EXPAND</td><td>The text to expand. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Returns the expanded text.</dd></dl>
<p> </blockquote> </p>
<h2><a class="anchor" id="lua_jam_getvar"></a>
function jam_getvar([ TARGET_NAME, ] VARIABLE_NAME)</h2>
<p><a name="lua_jam_getvar"></a></p>
<p> <blockquote> </p>
<p>Retrieves <code>VARIABLE_NAME</code> from the active Jam globals and returns it as a table of strings.</p>
<p>If <code>TARGET_NAME</code> is specified, <code>VARIABLE_NAME</code> is retrieved as if an <code>on TARGET_NAME</code> had been issued in Jam.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TARGET_NAME</td><td>(optional) The target to make active to retrieve <code>VARIABLE_NAME</code> from. </td></tr>
    <tr><td class="paramname">VARIABLE_NAME</td><td>The Jam variable to retrieve. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>All strings within the <code>VARIABLE_NAME</code> string are returned as a Lua array of strings.</dd></dl>
<p> </blockquote> </p>
<h2><a class="anchor" id="lua_jam_parse"></a>
function jam_parse(TEXT_TO_PARSE)</h2>
<p><a name="lua_jam_parse"></a></p>
<p> <blockquote> </p>
<p>Parses <code>TEXT_TO_PARSE</code> as if it existed in a Jamfile.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TEXT_TO_PARSE</td><td>Jam source code to be parsed and executed by Jam immediately.</td></tr>
  </table>
  </dd>
</dl>
<p> </blockquote> </p>
<h2><a class="anchor" id="lua_jam_print"></a>
function jam_print(TEXT_TO_PRINT)</h2>
<p><a name="lua_jam_print"></a></p>
<p> <blockquote> </p>
<p>Prints <code>TEXT_TO_PRINT</code> to the standard output stream.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TEXT_TO_PRINT</td><td>The text to print.</td></tr>
  </table>
  </dd>
</dl>
<p> </blockquote> </p>
<h2><a class="anchor" id="lua_jam_setvar"></a>
function jam_setvar([ TARGET_NAME, ] VARIABLE_NAME, VALUE)</h2>
<p><a name="lua_jam_setvar"></a></p>
<p> <blockquote> </p>
<p>Sets <code>VALUE</code> into the active Jam global <code>VARIABLE_NAME</code>. <code>VALUE</code> can be a boolean, number, string, or table. Nested tables are collapsed.</p>
<p>If <code>TARGET_NAME</code> is specified, <code>VALUE</code> is set into <code>VARIABLE_NAME</code> as if an <code>VARIABLE_NAME on TARGET_NAME</code> had been issued in Jam.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TARGET_NAME</td><td>(optional) The target to make active to set <code>VARIABLE_NAME</code> into. </td></tr>
    <tr><td class="paramname">VARIABLE_NAME</td><td>The Jam variable to set.</td></tr>
  </table>
  </dd>
</dl>
<p> </blockquote> </p>
<hr/>
 <h1><a class="anchor" id="lua_support_examples"></a>
Examples</h1>
<p> <blockquote>  </p><div class="fragment"><div class="line"><span class="preprocessor"># Hello</span></div>
<div class="line">LuaString <span class="stringliteral">&quot;print(&#39;Hello&#39;)&quot;</span> ;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># 10 hi false</span></div>
<div class="line">Echo [ LuaString <span class="stringliteral">&quot;return { 10, &#39;hi&#39;, false }&quot;</span> ] ;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># 5.suf hello.suf true.suf</span></div>
<div class="line">var = [ LuaString <span class="stringliteral">&quot;return { 5, &#39;hello&#39;, true }&quot;</span> ] ;</div>
<div class="line">Echo $(var:S=.suf) ;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#------------------------------------------------------------------------------</span></div>
<div class="line"><span class="preprocessor"># Hello world!</span></div>
<div class="line">var = Hello world! ;</div>
<div class="line">Echo [ LuaString <span class="stringliteral">&quot;return jam_getvar(&#39;var&#39;)&quot;</span> ] ;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># Hi everyone</span></div>
<div class="line">LuaString <span class="stringliteral">&quot;jam_setvar(&#39;var&#39;, &#39;Hi everyone&#39;)&quot;</span> ;</div>
<div class="line">Echo $(var) ;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># Hi everyone</span></div>
<div class="line">Echo [ LuaString <span class="stringliteral">&quot;return jam_getvar(&#39;var&#39;)&quot;</span> ] ;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#------------------------------------------------------------------------------</span></div>
<div class="line"><span class="preprocessor"># The Variable Contents</span></div>
<div class="line">MyVariable on mytarget = The Variable Contents ;</div>
<div class="line">Echo [ LuaString <span class="stringliteral">&quot;return jam_getvar(&#39;mytarget&#39;, &#39;MyVariable&#39;)&quot;</span> ] ;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># **hello**</span></div>
<div class="line">LuaString <span class="stringliteral">&quot;jam_setvar(&#39;mytarget&#39;, &#39;MyVariable&#39;, &#39;**hello**&#39;)&quot;</span> ;</div>
<div class="line">Echo [ LuaString <span class="stringliteral">&quot;return jam_getvar(&#39;mytarget&#39;, &#39;MyVariable&#39;)&quot;</span> ] ;</div>
<div class="line"></div>
<div class="line">rule ReturnList INPUT</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> **$(INPUT)** ;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># **MyStuff** **YourStuff**</span></div>
<div class="line"><span class="preprocessor">Echo [ LuaString &quot;return jam_evaluaterule(&#39;ReturnList&#39;, { &#39;MyStuff&#39;, &#39;YourStuff&#39; })&quot; ] ;</span></div>
</div><!-- fragment --><p>  </blockquote>  </p>
</div></div><!-- contents -->
</body>
</html>
